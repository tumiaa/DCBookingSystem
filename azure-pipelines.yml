name: Azure Static Web Apps CI/CD

trigger:
  branches:
    include:
      - "*"

variables:
  isMainBranch: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  isTestBranch: $[eq(variables['Build.SourceBranch'], 'refs/heads/test')]
  isDevBranch: $[and(ne(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.SourceBranch'],'refs/heads/test'))]

stages:
  - stage: Dev
    condition: and(succeeded(), eq(variables['isDevBranch'], true))
    jobs:
      
      - template: pipelines/set-env-variables-job.yml
        parameters:
          environment: DEV
      - job: unit_tests
        displayName: Run Unit Tests
        dependsOn: set_env_vars
        pool:
          vmImage: ubuntu-latest
        steps:
        - checkout: self
          submodules: true
        - task: NodeTool@0
          inputs:
            versionSpec: '16.x' # Specify the Node.js version
        - bash: |
            npm install
            npm run test:unit
      - template: pipelines/build-deploy-job.yml
        parameters:
          environment: DEV

  - stage: Test
    condition: and(succeeded(), eq(variables['isTestBranch'], true))
    dependsOn: Dev
    jobs:
      - template: pipelines/set-env-variables-job.yml
        parameters:
          environment: TEST
      - template: pipelines/build-deploy-job.yml
        parameters:
          environment: TEST

  - stage: Prod
    condition: and(succeeded(), eq(variables['isMainBranch'], true))
    dependsOn: Test
    jobs:
      - template: pipelines/set-env-variables-job.yml
        parameters:
          environment: PROD
      - template: pipelines/build-deploy-job.yml
        parameters:
          environment: PROD
